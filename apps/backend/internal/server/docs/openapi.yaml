openapi: 3.1.0
info:
  title: Eloquia API
  version: 0.1.0
servers:
  - url: /
paths:
  /health:
    get:
      summary: Liveness probe
      responses:
        "200":
          description: Service is alive
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusResponse"
  /ready:
    get:
      summary: Readiness probe
      responses:
        "200":
          description: Dependencies are ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusResponse"
        "503":
          description: Dependencies are not ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusResponse"
  /doctor/register:
    post:
      summary: Register a doctor account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DoctorRegisterRequest"
      responses:
        "201":
          description: Doctor created and session started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DoctorResponse"
        "400":
          description: Invalid request payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /doctor/login:
    post:
      summary: Authenticate a doctor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DoctorLoginRequest"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DoctorResponse"
        "400":
          description: Invalid request payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /doctor/me:
    get:
      summary: Fetch the current doctor
      security:
        - sessionCookie: []
      responses:
        "200":
          description: Current doctor
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DoctorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /doctor/logout:
    post:
      summary: Terminate the current session
      security:
        - sessionCookie: []
      responses:
        "200":
          description: Logged out
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatusResponse"
        "401":
          description: No active session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /practice:
    post:
      summary: Create a practice and assign the current doctor
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PracticeCreateRequest"
      responses:
        "201":
          description: Practice created and doctor assigned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PracticeCreateResponse"
        "400":
          description: Invalid request payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /links/invite:
    post:
      summary: Invite a patient to link with the doctor
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LinkInviteRequest"
      responses:
        "201":
          description: Link created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LinkResponse"
        "400":
          description: Invalid request payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Link already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /links/request:
    post:
      summary: Patient-side link request (placeholder)
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LinkInviteRequest"
      responses:
        "201":
          description: Link created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LinkResponse"
        "400":
          description: Invalid request payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Link already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /links/{id}/approve:
    post:
      summary: Approve a pending doctor-patient link
      security:
        - sessionCookie: []
      parameters:
        - name: id
          in: path
          required: true
          description: Link ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Link approved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LinkApproveResponse"
        "400":
          description: Invalid link id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Link not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /patients:
    get:
      summary: List patients and pending links for the current doctor
      security:
        - sessionCookie: []
      responses:
        "200":
          description: Patients and pending links
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PatientsResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
  /patients/{id}/entries:
    get:
      summary: List patient entries (doctor must have approved link)
      security:
        - sessionCookie: []
      parameters:
        - name: id
          in: path
          required: true
          description: Patient ID
          schema:
            type: string
            format: uuid
        - name: from
          in: query
          required: false
          description: ISO timestamp (RFC3339) lower bound
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          required: false
          description: ISO timestamp (RFC3339) upper bound
          schema:
            type: string
            format: date-time
      responses:
        "200":
          description: Entries for the patient
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EntriesResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: No approved link for this patient
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "400":
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
components:
  securitySchemes:
    sessionCookie:
      type: apiKey
      in: cookie
      name: eloquia_session
      description: Session cookie issued after login or registration.
  schemas:
    Doctor:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        displayName:
          type: string
        role:
          type: string
          enum: [Owner, Staff]
        practiceId:
          type: string
          format: uuid
          nullable: true
      required: [id, email, displayName, role]
    DoctorRegisterRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        displayName:
          type: string
        password:
          type: string
          format: password
          minLength: 8
      required: [email, displayName, password]
    DoctorLoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
      required: [email, password]
    DoctorResponse:
      type: object
      properties:
        doctor:
          $ref: "#/components/schemas/Doctor"
      required: [doctor]
    Practice:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        address:
          type: string
          nullable: true
        logoUrl:
          type: string
          format: uri
          nullable: true
      required: [id, name]
    PracticeCreateRequest:
      type: object
      properties:
        name:
          type: string
        address:
          type: string
          nullable: true
        logoUrl:
          type: string
          format: uri
          nullable: true
      required: [name]
    PracticeCreateResponse:
      type: object
      properties:
        practice:
          $ref: "#/components/schemas/Practice"
        doctor:
          $ref: "#/components/schemas/Doctor"
      required: [practice, doctor]
    Link:
      type: object
      properties:
        id:
          type: string
          format: uuid
        doctorId:
          type: string
          format: uuid
        patientId:
          type: string
          format: uuid
        status:
          type: string
          enum: [Pending, Approved, Denied, Revoked]
        requestedAt:
          type: string
          format: date-time
        approvedAt:
          type: string
          format: date-time
          nullable: true
      required: [id, doctorId, patientId, status, requestedAt]
    LinkInviteRequest:
      type: object
      properties:
        patientId:
          type: string
          format: uuid
        patientEmail:
          type: string
          format: email
        patientCode:
          type: string
        displayName:
          type: string
      description: Provide at least one patient identifier (id, email, or code)
    LinkResponse:
      type: object
      properties:
        link:
          $ref: "#/components/schemas/Link"
        patient:
          $ref: "#/components/schemas/Patient"
      required: [link, patient]
    LinkApproveResponse:
      type: object
      properties:
        link:
          $ref: "#/components/schemas/Link"
        patient:
          $ref: "#/components/schemas/Patient"
      required: [link, patient]
    Patient:
      type: object
      properties:
        id:
          type: string
          format: uuid
        displayName:
          type: string
        email:
          type: string
          format: email
          nullable: true
        patientCode:
          type: string
          nullable: true
      required: [id, displayName]
    PatientsResponse:
      type: object
      properties:
        patients:
          type: array
          items:
            $ref: "#/components/schemas/Patient"
        pendingLinks:
          type: array
          items:
            $ref: "#/components/schemas/Link"
      required: [patients, pendingLinks]
    Entry:
      type: object
      properties:
        id:
          type: string
          format: uuid
        patientId:
          type: string
          format: uuid
        happenedAt:
          type: string
          format: date-time
        situation:
          type: string
          nullable: true
        emotions:
          description: Arbitrary JSON emotions payload
        triggers:
          description: Arbitrary JSON triggers payload
        techniques:
          description: Arbitrary JSON techniques payload
        stutterFrequency:
          type: integer
          nullable: true
        notes:
          type: string
          nullable: true
        tags:
          description: Arbitrary JSON tags payload
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, patientId, happenedAt, createdAt, updatedAt]
    EntriesResponse:
      type: object
      properties:
        entries:
          type: array
          items:
            $ref: "#/components/schemas/Entry"
      required: [entries]
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
      required: [error]
    StatusResponse:
      type: object
      properties:
        status:
          type: string
      required: [status]
