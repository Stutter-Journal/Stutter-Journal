<div class="mx-auto max-w-6xl space-y-6 p-4 md:p-6">
  <!-- Header -->
  <div
    class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
  >
    <div>
      <div class="text-sm text-muted-foreground">Insights</div>
      <div class="text-2xl font-semibold leading-tight">Analytics</div>
      <div class="mt-1 text-sm text-muted-foreground">
        Monitor trends across shared entries, intensity shifts, and outcomes.
      </div>
    </div>

    <div class="flex items-center gap-2">
      <button hlmBtn type="button" variant="outline" (click)="saveView()">
        Save view
      </button>
      <button hlmBtn type="button" (click)="exportReport()">Export</button>
    </div>
  </div>

  <!-- KPI header -->
  <section class="grid gap-4 md:grid-cols-3">
    @if (loading()) {
      @for (s of skeletonCards; track s) {
        <div hlmCard>
          <div hlmCardHeader>
            <div hlmSkeleton class="h-4 w-28"></div>
            <div hlmSkeleton class="mt-3 h-8 w-24"></div>
          </div>
          <div hlmCardContent>
            <div hlmSkeleton class="h-4 w-36"></div>
          </div>
        </div>
      }
    } @else {
      @for (kpi of kpis(); track kpi.id) {
        <div hlmCard>
          <div hlmCardHeader class="flex items-start justify-between gap-3">
            <div>
              <div class="text-sm text-muted-foreground">{{ kpi.label }}</div>
              <div class="mt-2 text-3xl font-semibold">{{ kpi.value }}</div>
            </div>
            <span [variant]="badgeVariant(kpi.deltaTone)" hlmBadge>
              {{ kpi.delta }}
            </span>
          </div>
          <div hlmCardContent class="text-xs text-muted-foreground">
            {{ kpi.helper }}
          </div>
        </div>
      }
    }
  </section>

  <section class="space-y-2">
    @if (error()) {
      <div hlmAlert variant="destructive">
        <div hlmAlertTitle>Unable to load analytics</div>
        <div hlmAlertDescription>
          {{ error()?.message }}
        </div>
      </div>
    }

    @if (warning()) {
      <div hlmAlert>
        <div hlmAlertTitle>Partial analytics loaded</div>
        <div hlmAlertDescription>{{ warning() }}</div>
      </div>
    }

    @if (!loading() && !hasData()) {
      <div hlmAlert>
        <div hlmAlertTitle>No analytics yet</div>
        <div hlmAlertDescription>
          Ask patients to sync entries to start seeing trends.
        </div>
      </div>
    }

    @if (rangeNotice()) {
      <div hlmAlert>
        <div hlmAlertTitle>Range notice</div>
        <div hlmAlertDescription>{{ rangeNotice() }}</div>
      </div>
    }

    <div hlmAlert>
      <div hlmAlertTitle>Delta comparisons pending</div>
      <div hlmAlertDescription>
        Week-over-week deltas are placeholders until the API exposes comparison
        windows.
      </div>
    </div>

    <div hlmAlert>
      <div hlmAlertTitle>Filters are placeholders</div>
      <div hlmAlertDescription>
        Segment, environment, and advanced filters are UI-only until the API
        supports them.
      </div>
    </div>
  </section>

  <!-- Filter bar -->
  <section class="rounded-lg border bg-card p-4 space-y-4">
    <div class="grid gap-4 lg:grid-cols-3">
      <div class="space-y-2">
        <div class="text-xs font-medium text-muted-foreground">Segment</div>
        <brn-select [(ngModel)]="segment" class="w-full">
          <hlm-select-trigger class="w-full">
            <hlm-select-value />
          </hlm-select-trigger>
          <hlm-select-content>
            @for (option of segments; track option) {
              <hlm-option [value]="option">{{ option }}</hlm-option>
            }
          </hlm-select-content>
        </brn-select>
      </div>

      <div class="space-y-2">
        <div class="text-xs font-medium text-muted-foreground">Environment</div>
        <brn-select [(ngModel)]="environment" class="w-full">
          <hlm-select-trigger class="w-full">
            <hlm-select-value />
          </hlm-select-trigger>
          <hlm-select-content>
            @for (option of environments; track option) {
              <hlm-option [value]="option">{{ option }}</hlm-option>
            }
          </hlm-select-content>
        </brn-select>
      </div>

      <div class="space-y-2">
        <div class="text-xs font-medium text-muted-foreground">Project</div>
        <brn-select [(ngModel)]="project" class="w-full">
          <hlm-select-trigger class="w-full">
            <hlm-select-value />
          </hlm-select-trigger>
          <hlm-select-content>
            @for (option of projects; track option) {
              <hlm-option [value]="option">{{ option }}</hlm-option>
            }
          </hlm-select-content>
        </brn-select>
      </div>
    </div>

    <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
      <div class="flex flex-wrap items-center gap-3">
        <div class="flex items-center gap-2">
          <input
            hlmInput
            type="date"
            class="w-[160px]"
            [value]="dateFrom"
            (input)="dateFrom = ($any($event.target)).value; onDateInputChange()"
          />
          <span class="text-muted-foreground">to</span>
          <input
            hlmInput
            type="date"
            class="w-[160px]"
            [value]="dateTo"
            (input)="dateTo = ($any($event.target)).value; onDateInputChange()"
          />
        </div>

        <div hlmButtonGroup>
          <button
            hlmBtn
            size="sm"
            type="button"
            [variant]="preset() === '7d' ? 'default' : 'outline'"
            (click)="applyPreset('7d')"
          >
            7d
          </button>
          <button
            hlmBtn
            size="sm"
            type="button"
            [variant]="preset() === '30d' ? 'default' : 'outline'"
            (click)="applyPreset('30d')"
          >
            30d
          </button>
          <button
            hlmBtn
            size="sm"
            type="button"
            [variant]="preset() === 'ytd' ? 'default' : 'outline'"
            (click)="applyPreset('ytd')"
          >
            YTD
          </button>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <button
          [hlmDropdownMenuTrigger]="advancedMenu"
          hlmBtn
          type="button"
          variant="outline"
        >
          Advanced filters
        </button>

        <ng-template #advancedMenu>
          <hlm-dropdown-menu class="w-72">
            @for (filter of advancedFilters(); track filter.id) {
              <button
                hlmDropdownMenuItem
                type="button"
                (click)="toggleAdvancedFilter(filter.id)"
              >
                <div class="flex flex-col items-start gap-1">
                  <span class="text-sm font-medium">{{ filter.label }}</span>
                  <span class="text-xs text-muted-foreground">
                    {{ filter.hint }}
                  </span>
                </div>
                <span class="ml-auto text-xs text-muted-foreground">
                  {{ filter.enabled ? 'On' : 'Off' }}
                </span>
              </button>
            }
          </hlm-dropdown-menu>
        </ng-template>

        <div class="text-xs text-muted-foreground">
          {{ activeFiltersCount() }} filters active
        </div>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <section hlmTabs [tab]="activeTab()" (tabActivated)="activeTab.set($event)">
    <div hlmTabsList class="w-fit">
      <button hlmTabsTrigger="overview" type="button">Overview</button>
      <button hlmTabsTrigger="cohorts" type="button">Cohorts</button>
      <button hlmTabsTrigger="events" type="button">Events</button>
      <button hlmTabsTrigger="errors" type="button">Errors</button>
    </div>

    <div hlmTabsContent="overview">
      <div class="grid gap-4 lg:grid-cols-[2fr_1fr]">
        <div class="rounded-lg border bg-card p-4">
          <div
            class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
          >
            <div>
              <div class="text-base font-semibold">Activity timeline</div>
              <div class="text-sm text-muted-foreground">
                Daily entry volume and average stutter intensity.
              </div>
            </div>
          </div>

          <div
            hlmTableContainer
            class="mt-4 max-h-[360px] overflow-auto"
          >
            <table hlmTable>
              <caption hlmCaption>
                Daily activity
              </caption>

              <thead hlmTHead>
                <tr hlmTr>
                  <th
                    hlmTh
                    class="sticky top-0 z-10 bg-card/95 backdrop-blur"
                  >
                    <button type="button" (click)="setSort('date')">
                      Date{{ sortIndicator('date') }}
                    </button>
                  </th>
                  <th
                    hlmTh
                    class="sticky top-0 z-10 bg-card/95 backdrop-blur text-right"
                  >
                    <button type="button" (click)="setSort('entries')">
                      Entries{{ sortIndicator('entries') }}
                    </button>
                  </th>
                  <th
                    hlmTh
                    class="sticky top-0 z-10 bg-card/95 backdrop-blur text-right"
                  >
                    <button type="button" (click)="setSort('intensity')">
                      Avg intensity{{ sortIndicator('intensity') }}
                    </button>
                  </th>
                  <th
                    hlmTh
                    class="sticky top-0 z-10 bg-card/95 backdrop-blur text-right"
                  >
                    Delta
                  </th>
                  <th
                    hlmTh
                    class="sticky top-0 z-10 bg-card/95 backdrop-blur text-right"
                  >
                    Details
                  </th>
                </tr>
              </thead>

              <tbody hlmTBody>
                @if (loading()) {
                  @for (s of skeletonCards; track s) {
                    <tr hlmTr>
                      <td hlmTd>
                        <div hlmSkeleton class="h-4 w-20"></div>
                      </td>
                      <td hlmTd class="text-right">
                        <div hlmSkeleton class="ml-auto h-4 w-12"></div>
                      </td>
                      <td hlmTd class="text-right">
                        <div hlmSkeleton class="ml-auto h-4 w-12"></div>
                      </td>
                      <td hlmTd class="text-right">
                        <div hlmSkeleton class="ml-auto h-4 w-10"></div>
                      </td>
                      <td hlmTd class="text-right">
                        <div hlmSkeleton class="ml-auto h-8 w-20"></div>
                      </td>
                    </tr>
                  }
                } @else {
                  @if (trendRows().length === 0) {
                    <tr hlmTr>
                      <td hlmTd colspan="5" class="text-center text-sm text-muted-foreground">
                        No daily analytics available yet.
                      </td>
                    </tr>
                  } @else {
                    @for (row of trendRows(); track row.id) {
                      <tr hlmTr>
                        <td hlmTd>
                          <div class="font-medium">{{ fmtDate(row.date) }}</div>
                          <div class="text-xs text-muted-foreground">
                            {{ row.date }}
                          </div>
                        </td>
                        <td hlmTd class="text-right">
                          {{ fmtNumber(row.entries) }}
                        </td>
                        <td hlmTd class="text-right">
                          {{ row.avgIntensity.toFixed(1) }}
                        </td>
                        <td hlmTd class="text-right">{{ row.delta }}</td>
                        <td hlmTd class="text-right">
                          <hlm-sheet side="right">
                            <button
                              hlmBtn
                              hlmSheetTrigger
                              size="sm"
                              type="button"
                              variant="outline"
                            >
                              View
                            </button>
                            <hlm-sheet-content
                              *brnSheetContent
                              class="w-[360px] gap-4 p-6"
                            >
                              <div hlmSheetHeader>
                                <div hlmSheetTitle>{{ row.date }}</div>
                                <div hlmSheetDescription>
                                  Daily analytics snapshot
                                </div>
                              </div>

                              <div class="space-y-4">
                                <div class="grid gap-3">
                                  <div
                                    class="flex items-center justify-between text-sm"
                                  >
                                    <span class="text-muted-foreground">
                                      Entries
                                    </span>
                                    <span class="font-medium">
                                      {{ fmtNumber(row.entries) }}
                                    </span>
                                  </div>
                                  <div
                                    class="flex items-center justify-between text-sm"
                                  >
                                    <span class="text-muted-foreground">
                                      Avg intensity
                                    </span>
                                    <span class="font-medium">
                                      {{ row.avgIntensity.toFixed(1) }}
                                    </span>
                                  </div>
                                  <div
                                    class="flex items-center justify-between text-sm"
                                  >
                                    <span class="text-muted-foreground">
                                      Share of total
                                    </span>
                                    <span class="font-medium">
                                      {{ row.sharePercent }}%
                                    </span>
                                  </div>
                                </div>

                                <div class="text-sm text-muted-foreground">
                                  Keep an eye on spikes across consecutive days
                                  to identify potential stress clusters.
                                </div>
                              </div>
                            </hlm-sheet-content>
                          </hlm-sheet>
                        </td>
                      </tr>
                    }
                  }
                }
              </tbody>
            </table>
          </div>
        </div>

        <div class="rounded-lg border bg-card p-4 space-y-4">
          <div>
            <div class="text-base font-semibold">Signal health</div>
            <div class="text-sm text-muted-foreground">
              Most common emotions captured in the shared entries.
            </div>
          </div>

          @if (topEmotions().length === 0) {
            <div hlmAlert>
              <div hlmAlertTitle>This content is a placeholder</div>
              <div hlmAlertDescription>
                Emotion distributions have not been captured yet.
              </div>
            </div>
          } @else {
            <div class="space-y-3">
              @for (emotion of topEmotions(); track emotion.label) {
                <div class="space-y-2">
                  <div class="flex items-center justify-between text-sm">
                    <span>{{ emotion.label }}</span>
                    <span class="text-muted-foreground">
                      {{ emotion.percent }}%
                    </span>
                  </div>
                  <hlm-progress [value]="emotion.percent">
                    <div hlmProgressIndicator></div>
                  </hlm-progress>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>

    <div hlmTabsContent="cohorts">
      <div class="grid gap-4 lg:grid-cols-2">
        <div hlmAlert>
          <div hlmAlertTitle>This content is a placeholder</div>
          <div hlmAlertDescription>
            Cohort analytics are not available from the current API response.
          </div>
        </div>
        <div hlmAlert>
          <div hlmAlertTitle>This content is a placeholder</div>
          <div hlmAlertDescription>
            Cohort notes will populate once patient tenure data is exposed.
          </div>
        </div>
      </div>
    </div>

    <div hlmTabsContent="events">
      <div class="grid gap-4 lg:grid-cols-2">
        <div class="rounded-lg border bg-card p-4 space-y-4">
          <div>
            <div class="text-base font-semibold">Top triggers</div>
            <div class="text-sm text-muted-foreground">
              Events most often linked to higher intensity.
            </div>
          </div>

          @if (topTriggers().length === 0) {
            <div hlmAlert>
              <div hlmAlertTitle>This content is a placeholder</div>
              <div hlmAlertDescription>
                Trigger distributions have not been captured yet.
              </div>
            </div>
          } @else {
            <div class="space-y-3">
              @for (trigger of topTriggers(); track trigger.label) {
                <div class="flex items-center justify-between text-sm">
                  <div>
                    <div class="font-medium">{{ trigger.label }}</div>
                    <div class="text-xs text-muted-foreground">
                      {{ fmtNumber(trigger.count) }} mentions
                    </div>
                  </div>
                  <span class="text-muted-foreground">
                    {{ trigger.percent }}%
                  </span>
                </div>
              }
            </div>
          }
        </div>

        <div class="rounded-lg border bg-card p-4 space-y-4">
          <div>
            <div class="text-base font-semibold">Technique adoption</div>
            <div class="text-sm text-muted-foreground">
              What patients reach for during stressful moments.
            </div>
          </div>

          @if (topTechniques().length === 0) {
            <div hlmAlert>
              <div hlmAlertTitle>This content is a placeholder</div>
              <div hlmAlertDescription>
                Technique distributions have not been captured yet.
              </div>
            </div>
          } @else {
            <div class="space-y-3">
              @for (technique of topTechniques(); track technique.label) {
                <div class="flex items-center justify-between text-sm">
                  <div>
                    <div class="font-medium">{{ technique.label }}</div>
                    <div class="text-xs text-muted-foreground">
                      {{ fmtNumber(technique.count) }} uses
                    </div>
                  </div>
                  <span class="text-muted-foreground">
                    {{ technique.percent }}%
                  </span>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>

    <div hlmTabsContent="errors">
      <div class="grid gap-4 lg:grid-cols-2">
        <div hlmAlert>
          <div hlmAlertTitle>This content is a placeholder</div>
          <div hlmAlertDescription>
            Data quality alerts will appear once validation metrics are exposed.
          </div>
        </div>
        <div hlmAlert>
          <div hlmAlertTitle>This content is a placeholder</div>
          <div hlmAlertDescription>
            Action checklists will populate when error categories are available.
          </div>
        </div>
      </div>
    </div>
  </section>
</div>
