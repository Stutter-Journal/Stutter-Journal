- name: Determine base_host override
  set_fact:
    eloquia_base_host_override_resolved: "{{ eloquia_base_host_override | default(lookup('env', 'ELOQUIA_BASE_HOST') | default('', true)) | trim }}"
  changed_when: false

- name: "Set base_host from override (Mode B: local DNS)"
  when: eloquia_base_host_override_resolved | length > 0
  set_fact:
    eloquia_ingress_endpoint: ""
    eloquia_base_host: "{{ eloquia_base_host_override_resolved }}"

- name: "Determine ingress endpoint IP (Mode A: sslip.io)"
  when: eloquia_base_host_override_resolved | length == 0
  shell: |
    set -euo pipefail

    svc_ns="{{ ingress_namespace | default('ingress-nginx') }}"
    svc_name="ingress-nginx-controller"

    # Docker Desktop exposes ingress on localhost; prefer this even if a LoadBalancer IP is present.
    ctx=$(kubectl config current-context 2>/dev/null || true)
    if echo "$ctx" | grep -qi 'docker'; then
      echo "127.0.0.1"; exit 0
    fi

    # If the ingress controller service exists and has a LoadBalancer IP, use it.
    ip=$(kubectl get svc -n "${svc_ns}" "${svc_name}" -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || true)
    if [ -n "$ip" ]; then
      echo "$ip"; exit 0
    fi

    # Fallback: first node InternalIP
    node_ip=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}' 2>/dev/null || true)
    if [ -n "$node_ip" ]; then
      echo "$node_ip"; exit 0
    fi

    echo "127.0.0.1"
  args:
    executable: /bin/bash
  register: ingress_endpoint
  changed_when: false

- name: Set base_host for Mode A
  when: eloquia_base_host_override_resolved | length == 0
  set_fact:
    eloquia_ingress_endpoint: "{{ ingress_endpoint.stdout | trim }}"
    eloquia_base_host: "{{ (ingress_endpoint.stdout | trim) }}.sslip.io"

- name: Persist base_host
  copy:
    dest: "{{ playbook_dir }}/../../.state/base_host"
    content: "{{ eloquia_base_host }}\n"

- name: Write .env.runtime at repo root
  copy:
    dest: "{{ playbook_dir }}/../../../.env.runtime"
    content: |
      # Generated by infra/ansible (dns_mode)
      ELOQUIA_API_URL=http://api.{{ eloquia_base_host }}
      ELOQUIA_APP_URL=http://app.{{ eloquia_base_host }}

- name: Print chosen URLs
  debug:
    msg:
      - "API: http://api.{{ eloquia_base_host }}"
      - "APP: http://app.{{ eloquia_base_host }}"
