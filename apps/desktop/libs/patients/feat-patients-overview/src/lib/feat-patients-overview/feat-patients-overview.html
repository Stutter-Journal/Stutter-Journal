<div class="mx-auto max-w-6xl space-y-6 p-4 md:p-6">
  <!-- Header -->
  <div
    class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
  >
    <div>
      <div class="text-sm text-muted-foreground">Dashboard</div>
      <div class="text-2xl font-semibold leading-tight">Patients</div>
      <div class="mt-1 text-sm text-muted-foreground">
        Search, review and manage patient profiles
      </div>
    </div>

    <div class="flex items-center gap-2">
      <button (click)="openAddPatient()" hlmBtn type="button">
        <ng-icon hlm name="lucideUserPlus" size="base"></ng-icon>
        Add patient
      </button>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="rounded-lg border bg-card p-4">
    <div
      class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between"
    >
      <div class="flex flex-1 flex-col gap-2 md:flex-row md:items-center">
        <input
          (input)="onQueryInput(($any($event.target)).value)"
          [value]="query()"
          class="w-full md:max-w-sm"
          hlmInput
          placeholder="Search patients…"
          type="search"
        />

        <button
          [hlmDropdownMenuTrigger]="statusMenu"
          class="justify-between md:w-44"
          hlmBtn
          type="button"
          variant="outline"
        >
          Status: {{ statusFilterLabel() }}
          <span class="ml-2 text-muted-foreground">▾</span>
        </button>

        <ng-template #statusMenu>
          <hlm-dropdown-menu class="w-44">
            <button (click)="setStatusFilter('all')" hlmDropdownMenuItem>
              All
            </button>
            <button (click)="setStatusFilter('active')" hlmDropdownMenuItem>
              Connected
            </button>
            <button (click)="setStatusFilter('pending')" hlmDropdownMenuItem>
              Pending
            </button>
            <button (click)="setStatusFilter('revoked')" hlmDropdownMenuItem>
              Revoked
            </button>
            <button (click)="setStatusFilter('denied')" hlmDropdownMenuItem>
              Denied
            </button>
          </hlm-dropdown-menu>
        </ng-template>
      </div>

      <div class="text-sm text-muted-foreground">{{ totalItems() }} total</div>
    </div>

    <!-- Table / Empty -->
    <div class="mt-4">
      @if (totalItems() === 0) {
      <div class="border bg-background/50" hlmEmpty>
        <div hlmEmptyHeader>
          <div hlmEmptyMedia variant="icon">
            <ng-icon hlm name="lucideUsers" size="base"></ng-icon>
          </div>
          <div hlmEmptyTitle>No patients found</div>
          <div hlmEmptyDescription>
            Try a different search term or add your first patient.
          </div>
        </div>

        <div hlmItemFooter>
          <button (click)="openAddPatient()" hlmBtn type="button">
            Add patient
          </button>
        </div>
      </div>
      } @else {
      <div hlmTableContainer>
        <table hlmTable>
          <caption hlmCaption>
            Patients
          </caption>

          <thead hlmTHead>
            <tr hlmTr>
              <th hlmTh>Patient</th>
              <th class="w-[180px]" hlmTh>Status</th>
              <th class="w-[160px]" hlmTh>Requested</th>
              <th class="w-[160px]" hlmTh>Approved</th>
              <th class="w-[72px] text-right" hlmTh>Actions</th>
            </tr>
          </thead>

          <tbody hlmTBody>
            @for (p of pageRows(); track p.linkId) {
            <tr hlmTr>
              <td class="font-medium" hlmTd>
                <a
                  [routerLink]="['/app/patients', p.patientId]"
                  class="hover:underline"
                >
                  {{ p.fullName }}
                </a>
                @if (p.email) {
                <div class="text-xs text-muted-foreground">{{ p.email }}</div>
                }
              </td>

              <td hlmTd>
                <span [variant]="badgeVariant(p.status)" hlmBadge>
                  {{ statusLabel(p.status) }}
                </span>
              </td>

              <td hlmTd>{{ fmtDate(p.requestedAt) }}</td>
              <td hlmTd>{{ fmtDate(p.approvedAt) }}</td>

              <td class="text-right" hlmTd>
                <button
                  [hlmDropdownMenuTrigger]="rowMenu"
                  hlmBtn
                  size="sm"
                  type="button"
                  variant="ghost"
                >
                  <ng-icon
                    hlm
                    name="lucideMoreHorizontal"
                    size="base"
                  ></ng-icon>
                  <span class="sr-only">Open patient actions</span>
                </button>

                <ng-template #rowMenu>
                  <hlm-dropdown-menu class="w-44">
                    <button
                      [routerLink]="['/app/patients', p.patientId]"
                      hlmDropdownMenuItem
                    >
                      View
                    </button>

                    <button
                      [routerLink]="['/app/patients', p.patientId, 'edit']"
                      hlmDropdownMenuItem
                    >
                      Edit
                    </button>
                  </hlm-dropdown-menu>
                </ng-template>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex items-center justify-end">
        <hlm-numbered-pagination
          (currentPageChange)="page.set($event)"
          (itemsPerPageChange)="pageSize.set($event); page.set(1)"
          [currentPage]="page()"
          [itemsPerPage]="pageSize()"
          [totalItems]="totalItems()"
        />
      </div>
      }
    </div>
  </div>
</div>
